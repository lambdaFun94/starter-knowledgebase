import fs from "fs-extra";
import path from "path";
import {
  convertTemplateConfigToFeatureConfig
} from "../../../common/src/feature/features.js";
const createFeatureJson = async (templateModules, featurePath) => {
  const features = [];
  const streams = [];
  const featureNameToBundlePath = /* @__PURE__ */ new Map();
  for (const [featureName, module] of templateModules.entries()) {
    const featureConfig = convertTemplateConfigToFeatureConfig(module.config);
    features.push(featureConfig);
    featureNameToBundlePath.set(featureName, module.path);
    module.config.stream && streams.push({ ...module.config.stream });
  }
  const featureDir = path.dirname(featurePath);
  if (!fs.existsSync(featureDir)) {
    fs.mkdirSync(featureDir);
  }
  const featuresJson = mergeFeatureJson(featurePath, features, streams);
  fs.writeFileSync(featurePath, JSON.stringify(featuresJson, null, "  "));
  return featureNameToBundlePath;
};
const mergeFeatureJson = (featurePath, features, streams) => {
  let originalFeaturesJson = {};
  if (fs.existsSync(featurePath)) {
    originalFeaturesJson = JSON.parse(fs.readFileSync(featurePath).toString());
  }
  return {
    ...originalFeaturesJson,
    features,
    streams
  };
};
export {
  createFeatureJson
};
