import { getLocalDataForEntity } from "./getLocalData.js";
import { TEMPLATE_PATH } from "./constants.js";
import { generateTestDataForPage } from "./generateTestData.js";
import templateBase from "../public/templateBase";
import { getRelativePrefixToRootFromPath } from "../../../common/src/template/paths.js";
const pageLoader = async ({
  url,
  vite,
  templateFilename,
  entityId,
  featuresConfig,
  dynamicGenerateData,
  projectStructure
}) => {
  let template = templateBase;
  template = await vite.transformIndexHtml(url, template);
  const module = await vite.ssrLoadModule(`/${TEMPLATE_PATH}/${templateFilename}`);
  if (!module.default) {
    throw Error(`Default export missing in template: /${TEMPLATE_PATH}/${templateFilename}`);
  }
  const {
    default: Component,
    transformProps,
    getPath
  } = module;
  let document;
  if (dynamicGenerateData) {
    document = await generateTestDataForPage(process.stdout, featuresConfig, entityId, projectStructure);
  } else {
    document = await getLocalDataForEntity(entityId);
  }
  if (entityId && !document) {
    throw new Error(`Could not find document data for entityId: ${entityId}`);
  }
  let templateProps = {
    document,
    __meta: { mode: "development" }
  };
  if (transformProps) {
    templateProps = await transformProps(templateProps);
  }
  const path = getPath(templateProps);
  const templateRenderProps = {
    ...templateProps,
    path,
    relativePrefixToRoot: getRelativePrefixToRootFromPath(path)
  };
  return { template, Component, props: templateRenderProps };
};
export {
  pageLoader
};
